import { round } from 'curvy/utils'
import { Array as Arr, Effect } from 'effect'
import { generateGamut } from './gamut.ts'
import { doubleFactorial, factorial } from './harmonics.ts'
import { fitSphericalHarmonics } from './squares.ts'
import { CacheStorage } from './storage.ts'

const associatedLegendreString = Effect.fn(function* (l: number, m: number) {
	const prefactor = `(1 - x^2)^(${m / 2})`
	const terms: string[] = []

	const maxK = (l - m) / 2

	for (let k = 0; k <= maxK; k++) {
		// Calculate coefficient using explicit formula
		const numerator = (-1) ** k * (yield* factorial(2 * l - 2 * k))
		const denominator =
			(yield* factorial(k)) *
			(yield* factorial(l - k)) *
			(yield* factorial(l - m - 2 * k))
		const coef = numerator / denominator / 2 ** l
		const power = l - m - 2 * k

		// Format the term nicely
		let term = coef.toString()
		if (power > 0) {
			term += ` * x^${power}`
		}

		terms.push(term)
	}

	// Combine terms into polynomial expression
	const polynomial = terms.join(' + ')

	return `${prefactor} * (${polynomial})`
})

export const program = Effect.gen(function* () {
	const points = yield* generateGamut({
		subdivisions: 7,
		huePasses: 2,
		lightnessPasses: 1,
	})
	const result = yield* fitSphericalHarmonics(points, 48)

	yield* Effect.log(result)
	//
	// const coefficients = {
	// 	'0,0': 3.0879932575169438,
	// 	'2,0': 0.16033288369047366,
	// 	'2,2': 0.02369711512214885,
	// 	'4,0': 0.09809226030383365,
	// 	'4,2': 0.052187670839794656,
	// 	'4,4': -0.019348799479114605,
	// 	'6,0': -0.09794770328031986,
	// 	'6,2': -0.03199664411500593,
	// 	'6,4': -0.07890718476323937,
	// 	'6,6': 0.053468549580285143,
	// 	'8,0': 0.07603017644892957,
	// 	'8,2': 0.01052685879205151,
	// 	'8,4': 0.03156160419851901,
	// 	'8,6': -0.03284634859406244,
	// 	'8,8': -0.026204857461218388,
	// 	'10,0': -0.051955865939767684,
	// 	'10,4': -0.017459566020981428,
	// 	'10,8': -0.0036119956696034515,
	// 	'10,10': -0.031227544798629193,
	// 	'12,0': 0.03342173015022652,
	// 	'12,2': -0.008392782301872546,
	// 	'12,4': -0.0032849245977149472,
	// 	'12,6': 0.007172261208805043,
	// 	'12,8': 0.023465406303289107,
	// 	'12,10': -0.050550351138744634,
	// 	'12,12': -0.013809212888525062,
	// 	'14,0': -0.026356037822358482,
	// 	'14,2': 0.007133839387577355,
	// 	'14,4': 0.010894056240463428,
	// 	'14,6': -0.011665392125668698,
	// 	'14,8': -0.014145015437539684,
	// 	'14,10': -0.03186590207212687,
	// 	'16,0': 0.018597029071771756,
	// 	'16,2': -0.005733353999800965,
	// 	'16,4': -0.01619739093868965,
	// 	'16,6': 0.009459598397624466,
	// 	'16,8': 0.00638221037695229,
	// 	'16,12': 0.004276028982080325,
	// 	'16,14': 0.016329363114852263,
	// 	'16,16': 0.011242091527919476,
	// 	'18,0': -0.01689506001703239,
	// 	'18,2': 0.003925523153000852,
	// 	'18,4': 0.015796964860659266,
	// 	'18,6': -0.008978728693701825,
	// 	'18,10': -0.009560594128997265,
	// 	'18,16': 0.010765555272440908,
	// 	'20,0': 0.014492785963403698,
	// 	'20,2': -0.00394434337079776,
	// 	'20,4': -0.01320029716506483,
	// 	'20,6': 0.007670541187192733,
	// 	'20,10': -0.008818006120448075,
	// 	'20,12': -0.005111179362865387,
	// 	'20,14': 0.00844117168026992,
	// 	'20,16': -0.012471652052999268,
	// 	'20,18': -0.011058659625162594,
	// 	'20,20': 0.0035494684172540994,
	// 	'22,0': -0.012278669190242529,
	// 	'22,2': 0.004417904314276982,
	// 	'22,4': 0.010371874874683907,
	// 	'22,6': -0.007453283751694465,
	// 	'22,12': 0.005450543516217517,
	// 	'22,18': 0.011915947706608204,
	// 	'22,20': -0.00575911639303105,
	// 	'22,22': -0.009075938001300908,
	// 	'24,0': 0.012161363406562486,
	// 	'24,2': -0.003989029865074615,
	// 	'24,4': -0.0070144498161151285,
	// 	'24,6': 0.00663402098792924,
	// 	'24,10': -0.00735981020388899,
	// 	'24,18': 0.003737734646452305,
	// 	'24,22': -0.006038644634976063,
	// 	'24,24': 0.006232744398337178,
	// 	'26,0': -0.010926184594149999,
	// 	'26,2': 0.0033544791309563955,
	// 	'26,4': 0.004800631008092553,
	// 	'26,6': -0.005805388608549818,
	// 	'26,14': 0.0035629122027790614,
	// 	'26,20': -0.009076501952433013,
	// 	'26,24': 0.015886677349486455,
	// 	'28,0': 0.009682658889089693,
	// 	'28,4': -0.0034826157096238147,
	// 	'28,6': 0.005025581512528822,
	// 	'28,10': -0.004594465481156364,
	// 	'28,22': -0.004927067362937531,
	// 	'28,24': 0.0032978174687674972,
	// 	'28,26': 0.0036153009636920564,
	// 	'30,0': -0.008551534522130554,
	// 	'30,6': -0.004529259394630388,
	// 	'30,24': 0.010961159370216902,
	// 	'30,26': 0.004268294878276611,
	// 	'30,30': -0.006031097029677373,
	// 	'32,0': 0.006336054153197516,
	// 	'32,6': 0.004226683479353997,
	// 	'32,20': -0.0035176156679511627,
	// 	'32,24': 0.005475908984336416,
	// 	'32,30': -0.0076134116368749925,
	// 	'34,0': -0.004702309602181038,
	// 	'34,6': -0.003882947904457009,
	// 	'34,24': 0.00338747532311763,
	// 	'34,26': -0.005805630062830153,
	// 	'34,30': 0.004427857772806235,
	// 	'36,0': 0.0037913668752254603,
	// 	'36,6': 0.003135026555021023,
	// 	'36,18': 0.0031297232490322393,
	// 	'36,24': 0.0031108990082534755,
	// 	'36,26': 0.003928447852476506,
	// 	'38,34': 0.0033839864292943924,
	// 	'38,36': 0.0034714394475859303,
	// 	'40,24': 0.0036292351256357594,
	// 	'42,36': 0.0031154007278987855,
	// 	'42,40': -0.003426359449632146,
	// 	'44,24': 0.003553239125694915,
	// 	'46,38': -0.0038800491618943625,
	// 	'50,48': -0.0031456791744811263,
	//
	// 	// '10,2': 0.0029661228850767717,
	// 	// '14,12': -0.0029807065269467064,
	// 	// '16,10': -0.0026156746058481335,
	// 	// '18,12': 0.002098792497020286,
	// 	// '18,18': -0.002342632351085655,
	// 	// '22,16': -0.0027176012274651405,
	// 	// '24,8': 0.0022114322775405267,
	// 	// '24,12': -0.002526852436890829,
	// 	// '26,8': -0.0028544988709940673,
	// 	// '26,16': -0.0024422295910394927,
	// 	// '26,26': -0.00212568583375765,
	// 	// '28,2': -0.0022984694565252243,
	// 	// '28,8': 0.002627697934462916,
	// 	// '28,12': 0.0024805131566064155,
	// 	// '30,4': 0.0025931362260530524,
	// 	// '30,12': -0.00287950000437427,
	// 	// '30,18': 0.0023698118587073694,
	// 	// '32,4': -0.0025163956157360687,
	// 	// '32,10': -0.002515648544106684,
	// 	// '32,12': 0.0025170907240104857,
	// 	// '32,32': 0.0028944204491391777,
	// 	// '34,4': 0.0024812214000650536,
	// 	// '34,34': 0.0024635159706669204,
	// 	// '36,4': -0.002142441100234543,
	// 	// '36,20': -0.0028782905550002423,
	// 	// '38,0': -0.002926236628844995,
	// 	// '38,6': -0.0022851673474104713,
	// 	// '38,14': 0.0020568198817569306,
	// 	// '38,24': 0.0022628620409744873,
	// 	// '38,32': -0.0024413203661472786,
	// 	// '38,38': -0.00262426600799749,
	// 	// '40,0': 0.0027417179701063844,
	// 	// '40,18': 0.0023127997950518585,
	// 	// '40,20': -0.002672286781393907,
	// 	// '40,34': 0.0024475814545033537,
	// 	// '40,40': -0.0025481386822712817,
	// 	// '42,0': -0.002706004652153821,
	// 	// '42,14': 0.002017492702421579,
	// 	// '42,30': 0.002371558438119182,
	// 	// '42,32': -0.002947983141520409,
	// 	// '42,34': 0.00248070315965038,
	// 	// '44,0': 0.00232525366238303,
	// 	// '44,18': 0.002150925647868685,
	// 	// '44,20': -0.0021813967817505644,
	// 	// '44,34': 0.002851190476047689,
	// 	// '44,36': 0.002564815244828331,
	// 	// '44,40': -0.0022516775721989793,
	// 	// '46,0': -0.0022408251065700524,
	// 	// '46,46': 0.002093690662893737,
	// 	// '48,0': 0.002134364365974625,
	// 	// '48,24': 0.0024703628910525484,
	// 	// '52,24': 0.0021222132164306945,
	// 	// '52,52': -0.002078701781094065,
	// 	// '54,46': 0.0020017913809643024,
	// 	// '56,54': 0.00265517905260391,
	// 	// '58,50': -0.0020433283396943764,
	// 	// '60,48': -0.0020916223827527783,
	//
	// 	// '18,8': 0.0015746527856342445,
	// 	// '20,8': -0.001897512104235757,
	// 	// '22,10': 0.0014178394492037189,
	// 	// '24,20': 0.0016209405469190593,
	// 	// '26,10': 0.0014117843608241999,
	// 	// '26,18': 0.0015700619778598614,
	// 	// '26,22': 0.0014591064831592719,
	// 	// '28,20': 0.0015272714118383206,
	// 	// '28,28': 0.001102542505080073,
	// 	// '30,2': 0.001309035609034036,
	// 	// '30,8': -0.0013819764183083268,
	// 	// '30,10': 0.001052371367338425,
	// 	// '30,14': 0.0017148542134626983,
	// 	// '30,16': -0.001954070719659236,
	// 	// '30,28': 0.001213289427780614,
	// 	// '32,2': -0.0010895112751902023,
	// 	// '32,16': 0.0010179622352576017,
	// 	// '32,18': 0.0014510699614109503,
	// 	// '32,22': -0.0015618845469491155,
	// 	// '32,26': 0.001639571472630445,
	// 	// '32,28': -0.0019797510224514566,
	// 	// '34,2': 0.001058838822087061,
	// 	// '34,12': -0.0017276311117640365,
	// 	// '34,14': 0.001370860132536708,
	// 	// '34,16': -0.0014542741395385732,
	// 	// '34,18': -0.0013083406609390987,
	// 	// '34,20': 0.0017491962669824261,
	// 	// '36,2': -0.001084492837013524,
	// 	// '36,8': -0.0011864940666011466,
	// 	// '36,12': 0.0012967652560752089,
	// 	// '36,22': -0.0012722236328666428,
	// 	// '36,28': 0.0013536420673014526,
	// 	// '36,30': 0.0018904229875528835,
	// 	// '36,34': 0.0013285021772046453,
	// 	// '36,36': 0.0010811525180400596,
	// 	// '38,2': 0.001306711097764981,
	// 	// '38,4': 0.001816390302628384,
	// 	// '38,8': 0.00172054284730614,
	// 	// '38,12': -0.0011463282948480987,
	// 	// '38,18': -0.0017133333486048115,
	// 	// '38,20': 0.0015977638423322652,
	// 	// '40,2': -0.0013381253511098828,
	// 	// '40,4': -0.0011600596391623528,
	// 	// '40,6': 0.0015650128890030805,
	// 	// '40,8': -0.0018423752247237893,
	// 	// '40,12': 0.0013103657942583624,
	// 	// '40,14': -0.0014964876598538431,
	// 	// '40,16': -0.001206752041110629,
	// 	// '40,26': -0.0011358822364095748,
	// 	// '40,28': -0.001643101459239946,
	// 	// '40,32': -0.001530654381348319,
	// 	// '40,36': 0.001099000019559979,
	// 	// '40,38': -0.0012400202335407136,
	// 	// '42,2': 0.0012886487951359444,
	// 	// '42,6': -0.0011199756543784339,
	// 	// '42,8': 0.001701783248581629,
	// 	// '42,12': -0.0015088009303517573,
	// 	// '42,18': -0.001435007168329267,
	// 	// '42,20': 0.0018678081808924142,
	// 	// '42,26': 0.001312198597554577,
	// 	// '42,28': 0.0018060348461470242,
	// 	// '42,38': -0.001887904614406373,
	// 	// '44,2': -0.0012622769595500758,
	// 	// '44,6': 0.0010719268994132081,
	// 	// '44,8': -0.0013053660559171514,
	// 	// '44,12': 0.0017074336572929548,
	// 	// '44,14': -0.0016646868409632535,
	// 	// '44,22': -0.0011480427901305213,
	// 	// '44,26': -0.00114856653011335,
	// 	// '44,30': -0.0010987617839114928,
	// 	// '46,6': -0.0012102279564327717,
	// 	// '46,12': -0.001785160030909283,
	// 	// '46,14': 0.0019656678809797817,
	// 	// '46,18': -0.0014920718259751392,
	// 	// '46,20': 0.0010533884675730928,
	// 	// '46,26': 0.0012283469938593698,
	// 	// '46,30': 0.001170104239001081,
	// 	// '46,32': -0.0011844419478394632,
	// 	// '46,34': 0.0019700663954558217,
	// 	// '48,6': 0.0013252037011977132,
	// 	// '48,12': 0.0017728378470314838,
	// 	// '48,14': -0.0015698186488989681,
	// 	// '48,18': 0.0017993455836342997,
	// 	// '48,20': -0.0011162971847869358,
	// 	// '48,26': -0.0012903558978035177,
	// 	// '48,30': 0.0011979221284134911,
	// 	// '48,36': 0.0011463843092062642,
	// 	// '48,38': -0.001537082335709312,
	// 	// '48,44': 0.0010658625077482314,
	// 	// '48,46': 0.0018013624750592822,
	// 	// '50,0': -0.0017937679804633565,
	// 	// '50,6': -0.0014069758634806305,
	// 	// '50,12': -0.0015976945522852115,
	// 	// '50,14': 0.0013811623943355662,
	// 	// '50,18': -0.0011046104668345034,
	// 	// '50,26': 0.0011379304014908138,
	// 	// '50,30': -0.0011496244041595508,
	// 	// '50,34': 0.0017118271348129917,
	// 	// '50,36': 0.0017684571359440288,
	// 	// '50,38': -0.001038916911400423,
	// 	// '50,40': 0.0018037680642443395,
	// 	// '52,0': 0.0017163857885798758,
	// 	// '52,6': 0.0013836706856910862,
	// 	// '52,8': -0.001049332399707107,
	// 	// '52,12': 0.001326886131557223,
	// 	// '52,18': 0.0012447572329266506,
	// 	// '52,30': 0.001792083775902023,
	// 	// '52,34': 0.0015407082190863415,
	// 	// '52,38': -0.0017606942761123877,
	// 	// '52,48': -0.0010122866381035934,
	// 	// '54,0': -0.0015904995237809522,
	// 	// '54,6': -0.0012950424628910488,
	// 	// '54,8': 0.0010495034461443428,
	// 	// '54,12': -0.0010044321619321118,
	// 	// '54,40': 0.001145079913769739,
	// 	// '54,42': -0.0013569828695217188,
	// 	// '54,44': -0.001619353491814744,
	// 	// '54,50': -0.0019749634286382596,
	// 	// '56,0': 0.0013397338402360702,
	// 	// '56,6': 0.0011491418392708932,
	// 	// '56,24': 0.0010702214559283546,
	// 	// '56,30': 0.0011686571709938907,
	// 	// '56,32': -0.00170505021510019,
	// 	// '56,34': 0.0013136422618287998,
	// 	// '56,46': 0.001622627527128706,
	// 	// '56,48': -0.0018614400741788978,
	// 	// '56,50': -0.001929918343522562,
	// 	// '58,0': -0.001422783081834567,
	// 	// '58,38': -0.001059196468816281,
	// 	// '58,46': 0.0014282102639379918,
	// 	// '58,48': -0.0015811777162141652,
	// 	// '60,0': 0.001513593398535119,
	// 	// '60,32': -0.001348730317057616,
	// 	// '60,40': 0.0011031071348137473,
	// 	// '62,0': -0.0014870870483393768,
	// 	// '62,46': 0.0015767873206009406,
	// 	// '62,50': -0.0012765966442797691,
	// 	// '62,60': -0.0018535452416139453,
	// 	// '64,0': 0.0015894237266381526,
	// 	// '64,32': -0.0012795269847005939,
	// 	// '64,36': 0.001040995662034979,
	// 	// '64,38': -0.001847473286536199,
	// 	// '64,58': -0.0010472879079075387,
	//
	// 	// '10,6': -0.00013679835177995273,
	// 	// '14,14': 0.00033376937541567504,
	// 	// '18,14': -0.00004997709178307654,
	// 	// '22,8': 0.0006207985329715479,
	// 	// '22,14': 0.00038322850328900454,
	// 	// '24,14': 0.0007282610020876612,
	// 	// '24,16': 0.0006597820542774837,
	// 	// '26,12': -0.00031975282532321946,
	// 	// '28,14': -0.0008784973582171107,
	// 	// '28,16': -0.00012498022684159478,
	// 	// '28,18': 0.0003998558021468461,
	// 	// '30,20': -0.0007271076971449348,
	// 	// '30,22': -0.0009826567667325311,
	// 	// '32,8': 0.00034820819378326756,
	// 	// '32,14': 0.00002713978603417854,
	// 	// '34,8': 0.0005350392048571704,
	// 	// '34,10': 0.00024733041511246543,
	// 	// '34,22': -0.0002924335443123714,
	// 	// '34,28': -0.00020039938021401864,
	// 	// '34,32': 0.00017801203450048728,
	// 	// '36,10': -0.0006381097807151776,
	// 	// '36,14': -0.0009627115161508621,
	// 	// '36,16': -0.0004814200691964602,
	// 	// '36,32': 0.0003557245198151793,
	// 	// '38,10': -0.00008170914589396172,
	// 	// '38,16': 0.0005770931165239824,
	// 	// '38,22': -0.0005129133056524324,
	// 	// '38,26': -0.0006237420931549385,
	// 	// '38,28': 0.0005010967342101891,
	// 	// '38,30': 0.0007106995670266414,
	// 	// '40,10': -0.0004256108960596244,
	// 	// '40,22': -0.0005163996244497321,
	// 	// '40,30': 0.0007249140546857068,
	// 	// '42,4': 0.0003965418254734416,
	// 	// '42,10': 0.00018467660313016012,
	// 	// '42,16': 0.0003088820071449277,
	// 	// '42,22': -0.000033961914081431046,
	// 	// '42,24': -0.000494296744326518,
	// 	// '42,42': 0.0004578638092501691,
	// 	// '44,4': 0.0000387167355365878,
	// 	// '44,10': -0.0004452956190838747,
	// 	// '44,16': -0.0003404592773742346,
	// 	// '44,28': -0.0007320769521555931,
	// 	// '44,32': 0.000089249290933245,
	// 	// '44,38': -0.0009721058491831345,
	// 	// '44,42': -0.00007188998572277161,
	// 	// '44,44': 0.00011198475605090995,
	// 	// '46,2': 0.0009703499261138892,
	// 	// '46,4': -0.00032983831341788403,
	// 	// '46,8': 0.0009671379344243878,
	// 	// '46,10': -0.00011947649259564505,
	// 	// '46,16': -0.00012697833955927537,
	// 	// '46,22': 0.0004824048495803922,
	// 	// '46,24': -0.0003947296683760448,
	// 	// '46,28': 0.00012046045349908987,
	// 	// '46,36': -0.00015800874393795414,
	// 	// '46,40': 0.0002261148300480048,
	// 	// '46,42': -0.0003007110735453056,
	// 	// '46,44': 0.000677305836335309,
	// 	// '48,2': -0.0006039552397183027,
	// 	// '48,4': 0.0003473575820806447,
	// 	// '48,8': -0.0008609115427131247,
	// 	// '48,10': 0.00006526353137530414,
	// 	// '48,16': -0.00014565270509177606,
	// 	// '48,22': -0.000707938737689111,
	// 	// '48,28': 0.00004588945819151234,
	// 	// '48,32': -0.0007961314294772214,
	// 	// '48,34': 0.00016926755905593348,
	// 	// '48,40': 0.00015463920495449785,
	// 	// '48,42': -0.00042696178251257997,
	// 	// '48,48': -0.00045356186128269095,
	// 	// '50,2': 0.00035348942572329756,
	// 	// '50,4': -0.0000720406407658607,
	// 	// '50,8': 0.0009484741369773783,
	// 	// '50,10': -0.0003460582160635748,
	// 	// '50,16': 0.00003138689699254773,
	// 	// '50,20': 0.0005205343447913044,
	// 	// '50,22': -0.00011982408451484812,
	// 	// '50,24': -0.0005070965317476954,
	// 	// '50,28': 0.0001853307644260105,
	// 	// '50,32': -0.0006860050994862254,
	// 	// '50,42': -0.00017000317870911094,
	// 	// '50,44': -0.0007597442609380105,
	// 	// '50,46': 0.00017570835647523944,
	// 	// '50,50': -0.00028494855818170104,
	// 	// '52,2': -0.00018915028230275736,
	// 	// '52,4': -0.0001406292042550778,
	// 	// '52,10': 0.0002494387103739116,
	// 	// '52,14': -0.0008959113920594759,
	// 	// '52,16': -0.00019604146657610904,
	// 	// '52,20': -0.000895797912347486,
	// 	// '52,22': -0.00020656091371062957,
	// 	// '52,26': -0.00084285285958112,
	// 	// '52,28': -0.00015030142336199822,
	// 	// '52,32': -0.0008224423447422985,
	// 	// '52,36': -0.00014868417189313615,
	// 	// '52,40': -0.0002635270372657774,
	// 	// '52,42': -0.0008619632828073689,
	// 	// '52,44': 0.00036903097028020867,
	// 	// '52,46': -0.0006565072727949409,
	// 	// '52,50': -0.0009928579423751,
	// 	// '54,2': 0.00023573621602571599,
	// 	// '54,4': 0.0003440315465341551,
	// 	// '54,10': -0.00016413145229853714,
	// 	// '54,14': 0.0007906431422139553,
	// 	// '54,16': 0.00011907865396265318,
	// 	// '54,18': -0.0008297389861170793,
	// 	// '54,20': 0.0006005219181323485,
	// 	// '54,22': -0.00013453330872021537,
	// 	// '54,24': -0.00023291118765396434,
	// 	// '54,26': 0.0007160172237478314,
	// 	// '54,28': -0.000014743637449071261,
	// 	// '54,30': -0.0008782252677348018,
	// 	// '54,32': 0.0004215131719715771,
	// 	// '54,34': -0.00009302995241456083,
	// 	// '54,36': 0.0007325752435911948,
	// 	// '54,38': -0.0008210431981264249,
	// 	// '54,48': -0.0004101851106094071,
	// 	// '54,52': -0.000747069796844167,
	// 	// '54,54': 0.00047508596222548894,
	// 	// '56,2': -0.00044483316408633073,
	// 	// '56,4': -0.0005070164558002941,
	// 	// '56,8': -0.0008966045107893594,
	// 	// '56,10': -0.00007423829798647877,
	// 	// '56,12': 0.0007487781248145785,
	// 	// '56,14': -0.0005862959234836601,
	// 	// '56,16': -0.00031575809568473284,
	// 	// '56,18': 0.0008681615687217506,
	// 	// '56,20': -0.0008856255228108388,
	// 	// '56,22': -0.0002670721757214758,
	// 	// '56,26': -0.0008060409384892122,
	// 	// '56,28': 0.0003061044123464652,
	// 	// '56,36': 0.000991805636245656,
	// 	// '56,38': -0.0006166151476567673,
	// 	// '56,40': -0.00007461116741315572,
	// 	// '56,42': 0.00012348059535894214,
	// 	// '56,44': 0.0009180732123408662,
	// 	// '56,52': -0.0005228606151631395,
	// 	// '56,56': 0.00039344996949642507,
	// 	// '58,2': 0.0005938114418206457,
	// 	// '58,4': 0.0004942098558873266,
	// 	// '58,6': -0.0009558442008597892,
	// 	// '58,8': 0.0006566395591992768,
	// 	// '58,10': 0.00012888444488154556,
	// 	// '58,12': -0.0006137300137623949,
	// 	// '58,14': 0.0006590238129988607,
	// 	// '58,16': 0.0002736372229144777,
	// 	// '58,18': -0.00045095328606466396,
	// 	// '58,20': 0.0005320139339041882,
	// 	// '58,22': -0.00016457542159443726,
	// 	// '58,24': 0.00046652714104769474,
	// 	// '58,26': 0.0009478577658502324,
	// 	// '58,28': -0.0003619804490994908,
	// 	// '58,30': -0.0005159289877046724,
	// 	// '58,32': 0.0008537252916229589,
	// 	// '58,34': 0.0005625369404652037,
	// 	// '58,36': -0.00011452453062567344,
	// 	// '58,40': 0.00006636725254155747,
	// 	// '58,42': -0.0005999788209399878,
	// 	// '58,44': -0.000554994639594044,
	// 	// '58,52': 0.00011388224512079109,
	// 	// '58,54': 0.00022299356374172366,
	// 	// '58,56': -0.00003664310830549807,
	// 	// '58,58': 0.0003196636891618979,
	// 	// '60,2': -0.0006880945689708514,
	// 	// '60,4': -0.00048108004996024996,
	// 	// '60,6': 0.0007710203449248474,
	// 	// '60,8': -0.00040962129645044946,
	// 	// '60,10': -0.00039138454469689945,
	// 	// '60,12': 0.0005421261041309431,
	// 	// '60,14': -0.0005706038495301848,
	// 	// '60,16': -0.00032546941210094993,
	// 	// '60,18': 0.00035823357939718703,
	// 	// '60,20': -0.0006427138090579544,
	// 	// '60,22': 0.00004588025023397157,
	// 	// '60,24': 0.00045917624610300304,
	// 	// '60,26': -0.0009836825584131628,
	// 	// '60,28': 0.0003715660197090002,
	// 	// '60,30': 0.0006699482950736828,
	// 	// '60,34': 0.0005314367380753131,
	// 	// '60,36': 0.0009316680453923365,
	// 	// '60,38': -0.000971566463524698,
	// 	// '60,42': -0.00020556694815733202,
	// 	// '60,44': -0.00041857063864012565,
	// 	// '60,46': 0.00010443267123472574,
	// 	// '60,50': -0.00019090270266141162,
	// 	// '60,52': 0.000009040650287591063,
	// 	// '60,54': -0.00043747105264860784,
	// 	// '60,56': 0.0002317671857153389,
	// 	// '60,58': -0.0009651766169985151,
	// 	// '60,60': -0.00032014651227458586,
	// 	// '62,2': 0.0006728440482933741,
	// 	// '62,4': 0.0005269850007786358,
	// 	// '62,6': -0.0006657556753520897,
	// 	// '62,8': 0.0001718323446795094,
	// 	// '62,10': 0.0004439948401759298,
	// 	// '62,12': -0.0005062436882327328,
	// 	// '62,14': 0.00048001700010813725,
	// 	// '62,16': 0.00010321485421871367,
	// 	// '62,18': -0.00006986155959292446,
	// 	// '62,20': 0.00037608713339186905,
	// 	// '62,22': -0.00040652586530539697,
	// 	// '62,24': 0.00045289026563160196,
	// 	// '62,26': 0.0008203719753393454,
	// 	// '62,28': -0.00032950707994292916,
	// 	// '62,30': -0.00009394042541321413,
	// 	// '62,32': 0.0006469729518539228,
	// 	// '62,34': 0.0003846352944901442,
	// 	// '62,36': -0.0002054886164085776,
	// 	// '62,38': 0.0004487715741077462,
	// 	// '62,40': -0.0006086265149747253,
	// 	// '62,42': -0.00051056342289675,
	// 	// '62,44': -0.00003351378591871814,
	// 	// '62,48': -0.000954446526225233,
	// 	// '62,52': 0.0006714697129963181,
	// 	// '62,54': 0.00006158806356212354,
	// 	// '62,56': 0.0001844441077891762,
	// 	// '62,58': -0.0005488268374708019,
	// 	// '62,62': 0.00007908022250838724,
	// 	// '64,2': -0.0005455440071283591,
	// 	// '64,4': -0.0004825726713066687,
	// 	// '64,6': 0.0006475929906887408,
	// 	// '64,8': -0.00003956846535724865,
	// 	// '64,10': -0.00048750579895879875,
	// 	// '64,12': 0.0004650885878189243,
	// 	// '64,14': -0.00027611899446633085,
	// 	// '64,16': 0.00001725464401352764,
	// 	// '64,18': 0.00012794113496607932,
	// 	// '64,20': -0.0003958567446143979,
	// 	// '64,22': 0.0002418215013562222,
	// 	// '64,24': 0.0004282849458376635,
	// 	// '64,26': -0.0006204570657229908,
	// 	// '64,28': 0.00043471265417305857,
	// 	// '64,30': 0.0002950647529753195,
	// 	// '64,34': 0.0006361185708978413,
	// 	// '64,40': 0.0005957731970644825,
	// 	// '64,42': -0.0002700913885401134,
	// 	// '64,44': -0.00018151390850389924,
	// 	// '64,46': 0.00025063193564727815,
	// 	// '64,48': -0.0009837613481139353,
	// 	// '64,52': 0.0009758489746388494,
	// 	// '64,54': -0.0006166552615029012,
	// 	// '64,56': -0.00039807095127012283,
	// 	// '64,60': -0.0005387125206646676,
	// 	// '64,62': -0.0002150373333418119,
	// 	// '64,64': 0.0004174663648987344,
	//
	// 	// '64,50': -1.0890583474444594e-7,
	// } as const
	//
	// // Assume theta and phi are given:
	// const theta = Math.PI / 4 // e.g. 45° polar angle
	// const phi = Math.PI / 3 // e.g. 60° azimuthal angle
	// const x = 'cos(theta)' // We'll refer to x as cos(theta) in our logged expressions.
	// const PI = 'pi'
	//
	// // Minimal inline factorial definition (for small integers)
	// const factExpression =
	// 	'fact(n): for i = 2 to n, multiply i; fact(n) = product(i=2 to n)'
	// yield* Effect.log(factExpression)
	//
	// for (const [key, a] of Object.entries(coefficients)) {
	// 	// Extract l and m from key "l,m"
	// 	const [l, m] = key.split(',').map(Number) as [number, number]
	//
	// 	yield* Effect.log(`l=${l}, m=${m}, a=${a}`)
	//
	// 	yield* Effect.log(yield* associatedLegendreString(l, m))
	// 	//
	// 	// const n =
	// 	// 	(Math.sqrt(2 * l + 1) * (yield* factorial(l - m))) /
	// 	// 	(4 * Math.PI * (yield* factorial(l + m)))
	// 	//
	// 	// if (l === m) {
	// 	// 	const c0 = (-1) ** m * (yield* doubleFactorial(2 * m - 1))
	// 	// 	const e0 = m / 2
	// 	// 	yield* Effect.log(
	// 	// 		`P_${m}^${m}(x) = (-1)^${m} * doubleFactorial(2*${m}-1) * (1 - x^2)^(${m}/2)`,
	// 	// 	)
	// 	// } else {
	// 	// 	yield* Effect.log(
	// 	// 		`P_${m}^${m}(x) = (-1)^${m} * doubleFactorial(2*${m}-1) * (1 - x^2)^(${m}/2).`,
	// 	// 	)
	// 	// 	yield* Effect.log(
	// 	// 		`P_${Number(m) + 1}^${m}(x) = x * (2*${m}+1) * P_${m}^${m}(x).`,
	// 	// 	)
	// 	//
	// 	// 	yield* Effect.log(
	// 	// 		`P_prev = P_${m}^${m}(x), P_curr = P_${Number(m) + 1}^${m}(x).`,
	// 	// 	)
	// 	// 	yield* Effect.log(`For ll from ${Number(m) + 2} to ${l}:`)
	// 	// 	yield* Effect.log(
	// 	// 		`    P_{ll}^${m}(x) = [ (2*ll - 1)*x*P_{ll-1}^${m}(x) - (ll + ${m} - 1)*P_{ll-2}^${m}(x) ] / (ll - ${m})`,
	// 	// 	)
	// 	// 	yield* Effect.log(`Set P = P_${l}^${m}(x).`)
	// 	// }
	// 	//
	// 	// // Log spherical harmonic calculation:
	// 	// if (m === 0) {
	// 	// 	yield* Effect.log(
	// 	// 		`Y_{${l},0}(theta, phi) = N_{${l},0} * P_${l}(cos(theta))`,
	// 	// 	)
	// 	// } else {
	// 	// 	yield* Effect.log(
	// 	// 		`Y_{${l},${m}}(theta, phi) = sqrt(2) * N_{${l},${m}} * P_${l}^${m}(cos(theta)) * cos(${m} * phi)`,
	// 	// 	)
	// 	// }
	// 	//
	// 	// yield* Effect.log(
	// 	// 	`Then the term is: a_{${l},${m}} * Y_{${l},${m}}(theta, phi)`,
	// 	// )
	// }
	// // yield* Effect.log(
	// // 	'f(theta, phi) = Sum over all (l, m) [ a_{l,m} * Y_{l,m}(theta, phi) ]',
	// // )
})

const foo = {
	'0,0': 3.088047340567712,
	'2,0': 0.16037650247784152,
	'2,2': 0.02352590620826748,
	'4,0': 0.09805183658992693,
	'4,2': 0.05230066627451192,
	'4,4': -0.019135333434638573,
	'6,0': -0.09801419557822032,
	'6,2': -0.032065171565481734,
	'6,4': -0.07889300152945293,
	'6,6': 0.05380950504092267,
	'8,0': 0.07603206979690584,
	'8,2': 0.010660901356342999,
	'8,4': 0.031410048954654865,
	'8,6': -0.03274547657166209,
	'8,8': -0.026066223413577814,
	'10,0': -0.051823511538470195,
	'10,4': -0.017644939756829462,
	'10,10': -0.03135069340867037,
	'12,0': 0.03339680870561261,
	'12,6': 0.006713544015412863,
	'12,8': 0.023514274169527706,
	'12,10': -0.05066850641436286,
	'12,12': -0.014113844918432872,
	'14,0': -0.026442188986912682,
	'14,4': 0.010773333202003505,
	'14,6': -0.011363556532676638,
	'14,8': -0.014076557899370382,
	'14,10': -0.031956908329245456,
	'16,0': 0.01868884343664324,
	'16,4': -0.016045700883887844,
	'16,8': 0.006578869660488754,
	'16,14': 0.01644475366759425,
	'16,16': 0.01132713693098231,
	'18,0': -0.016992496587948856,
	'18,4': 0.015706168028805267,
	'18,16': 0.010862821925887198,
	'20,0': 0.014532601473827504,
	'20,4': -0.013190958703173687,
	'20,16': -0.012136897910486364,
	'20,18': -0.011462537650280291,
	'22,0': -0.012354583269049972,
	'22,4': 0.010378803634968039,
	'22,18': 0.01197201691002233,
	'22,20': -0.006175657575154513,
	'24,0': 0.012301183509306087,
	'24,6': 0.006613289257312381,
	'24,22': -0.006068249029977352,
	'26,0': -0.011075971902397144,
	'26,24': 0.016016648452043772,
	'30,24': 0.01128951974021263,
	'32,0': 0.006513184190746296,
	// '12,2': -0.008208723671904424,
	// '14,2': 0.007048901183112446,
	// '16,2': -0.005642664210944139,
	// '16,6': 0.00932361440326331,
	// '18,6': -0.008827889820028065,
	// '18,10': -0.009532795037955791,
	// '20,6': 0.007720253301702785,
	// '20,10': -0.008745100164391558,
	// '20,12': -0.005190915232897161,
	// '20,14': 0.00844654358515682,
	// '22,6': -0.007469823454266882,
	// '22,12': 0.005574283837056121,
	// '22,22': -0.009242163808670833,
	// '24,4': -0.007071070754714297,
	// '24,10': -0.00736064885565113,
	// '24,24': 0.005835400310340983,
	// '26,6': -0.005728111901695873,
	// '26,20': -0.009149907158514655,
	// '28,0': 0.009803479962423343,
	// '30,0': -0.008660549316866096,
	// '30,30': -0.005717329081539371,
	// '32,24': 0.0053896592720599915,
	// '32,30': -0.007922725427160953,
	// '34,26': -0.0059785580034477145,
}

const bar = {
	'0,0': 3.0879809732206254,
	'2,0': 0.16036291267944153,
	'2,2': 0.02366111337812845,
	'4,0': 0.09797954444202747,
	'4,2': 0.05221865502564765,
	'4,4': -0.019295165864524816,
	'6,0': -0.0978595432423909,
	'6,2': -0.03200331967366078,
	'6,4': -0.07896587763386514,
	'6,6': 0.05347193786143576,
	'8,0': 0.07594508114492564,
	'8,2': 0.010510662388151149,
	'8,4': 0.03153056839078572,
	'8,6': -0.03288568539920701,
	'8,8': -0.0261929585484522,
	'10,0': -0.051848462633144514,
	'10,4': -0.017437968992390064,
	'10,10': -0.031209890774707916,
	'12,0': 0.033357731204230315,
	'12,8': 0.023504162770582558,
	'12,10': -0.05044435508418341,
	'12,12': -0.0138013921644533,
	'14,0': -0.026367665723397524,
	'14,4': 0.010946472485052648,
	'14,6': -0.011664818162352174,
	'14,8': -0.014193796067647185,
	'14,10': -0.031873771026327144,
	'16,0': 0.018580930564855668,
	'16,4': -0.016227443260445534,
	'16,8': 0.006425681516016097,
	'16,14': 0.0163604189007434,
	'16,16': 0.011225785906937446,
	'18,0': -0.01685603618202585,
	'18,4': 0.015795246416358003,
	'18,16': 0.0107234649788124,
	'20,0': 0.014500310168669055,
	'20,4': -0.013256245390733458,
	'20,16': -0.01250790409011558,
	'20,18': -0.011000561296123272,
	'22,0': -0.012282618207157111,
	'22,4': 0.01045559424529199,
	'22,18': 0.011924615047263389,
	'24,0': 0.012087042268879234,
	'24,4': -0.006966244742001801,
	'24,6': 0.006684071769240677,
	'24,22': -0.006193315206386093,
	'24,24': 0.006344925298693814,
	'26,0': -0.010883296702698258,
	'26,24': 0.01585755195662203,
	'30,24': 0.0109333796599962,
	'30,30': -0.0062092692282326506,
	'32,0': 0.006165227072071984,

	// "12,2": -0.008414393647638598,
	// "12,6": 0.00709817901660525,
	// "14,2": 0.007175365657730382,
	// "16,2": -0.005749978293908553,
	// "16,6": 0.009510810444556615,
	// "16,12": 0.004249810372731657,
	// "18,6": -0.008929199602289148,
	// "18,10": -0.009426098604118045,
	// "20,6": 0.007700027077067569,
	// "20,10": -0.008817286673078935,
	// "20,12": -0.00511388716471146,
	// "20,14": 0.008481023986665432,
	// "22,2": 0.0044575944397657365,
	// "22,6": -0.007560030216120322,
	// "22,12": 0.005374614506137254,
	// "22,20": -0.0057755666389229954,
	// "22,22": -0.009080527840601793,
	// "24,10": -0.007397390141367688,
	// "26,4": 0.004734753933978802,
	// "26,6": -0.0057907515770467665,
	// "26,20": -0.009144246426380502,
	// "28,0": 0.009664751613358157,
	// "28,6": 0.004999095041480792,
	// "28,10": -0.004534048940713309,
	// "28,22": -0.005160214027379025,
	// "30,0": -0.008452939565123566,
	// "30,6": -0.004444621328025518,
	// "30,26": 0.004137634694389475,
	// "32,6": 0.00409348048912588,
	// "32,24": 0.005574827568171705,
	// "32,30": -0.0074894000922722664,
}
